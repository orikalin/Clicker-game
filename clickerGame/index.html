<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="clicker_ss.css">
    <title>dragon clicker</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

</head>

<body>
    <div class="nav" id="nav"></div>

    <div class="wrapper" id="wrapper">
        <canvas id="canvasDragon" class="canvasDragon" width="600" height="500"></canvas>
        <div class="borderPins">
            <div class="borderPinHL1"></div>
            <div class="borderPinHL2"></div>
            <div class="borderPinHR1"></div>
            <div class="borderPinFull"></div>
            <div class="borderPinBot1"></div>
            <div class="borderPinBot2"></div>
            <div class="borderPinBot3"></div>
            <div class="borderPinTop1"></div>
            <div class="borderPinTop2"></div>
            <div class="borderPinTop3"></div>

        </div>
        <div class="borders">
            <div class="hBorder1"></div>
            <div class="hBorder2"></div>
            <div class="vBorder1"></div>
            <div class="vBorder2"></div>
            <div class="vBorder3"></div>
            <div class="hBorderBtm"></div>
        </div>
        <div class="leftSection" id="leftSection">
            <div class="dragonArea" id="dragonArea">
                <div id="animations"></div>
                <div class="goldWrapper">
                    <div id="goldDisplay" class="goldDisplay"> Gold: 0</div>
                    <div id="gpsDisplay" class="gpsDisplay" style="font-size:50%;">Gold per second : 0</div>
                </div>
                <div class="dragonAnchor">
                    <div id="theDragon" class="theDragon disable-dbl-tap-zoom"></div>
                </div>
                <div id="toolTipWindow" class="toolTipWindow">
                    <div class="ttIcon"></div><img class="coinStack" src="art/coinStack.png">
                    <div class="ttName"></div><br>
                    <div class="ttDesc"></div>
                </div>
            </div>

            <div class="playerArea" id="playerArea">
                <div class="namePlate">
                    <div id="changeNamePlate" onclick="changeName()">Change</div>
                    <div class="playerName"></div>
                </div>
                <div id="stats" class="stats">Stats readout coming soon!</div>
                <div class="playerAnchor">
                    <div id="thePlayer" class="thePlayer"></div>
                </div>
            </div>
        </div>
        <div class="shopSection" id="shopSection">
            <div class="shopHeader">Shop graphics go here</div>
            <div class="shopWrapper">
                <div class="theShop">
                    <div id="ironSword" class="ironSword shopItem shadowedItem" onmouseover='ironSwordObj.showToolTip()' onmouseout="ttClear()" onclick="ironSwordObj.buyFlatUpgradeItem()"></div>
                    <div id="steelSword" class="steelSword shopItem shadowedItem shopHidden" onmouseover='steelSwordObj.showToolTip()' onmouseout="ttClear()" onclick="steelSwordObj.buyFlatUpgradeItem()"></div>
                    <div id="boneSword" class="boneSword shopItem shadowedItem shopHidden" onmouseover='boneSwordObj.showToolTip()' onmouseout="ttClear()" onclick="boneSwordObj.buyFlatUpgradeItem()"></div>
                    <div id="greatSword" class="greatSword shopItem shadowedItem shopHidden" onmouseover='greatSwordObj.showToolTip()' onmouseout="ttClear()" onclick="greatSwordObj.buyFlatUpgradeItem()"></div>
                    <div id="goldenLoop" class="goldenLoop shopItem shadowedItem" onmouseover='goldenLoopObj.showToolTip()' onmouseout="ttClear()" onclick="goldenLoopObj.buyRateUpgradeItem()"></div>
                    <div id="ringOfMidas" class="ringOfMidas shopItem shadowedItem shopHidden" onmouseover='ringOfMidasObj.showToolTip()' onmouseout="ttClear()" onclick="ringOfMidasObj.buyRateUpgradeItem()"></div>
                    <div id="newbManual1" class="newbManual1 shopItem shadowedItem shopHidden" onmouseover='newbManual1Obj.showToolTip()' onmouseout="ttClear()" onclick="newbManual1Obj.buyGuildUpgrade()"></div>
                    <div id="newbManual2" class="newbManual2 shopItem shadowedItem shopHidden" onmouseover='newbManual2Obj.showToolTip()' onmouseout="ttClear()" onclick="newbManual2Obj.buyGuildUpgrade()"></div>
                    <div id="koboldHat1" class="koboldHat1 shopItem shadowedItem shopHidden" onmouseover='koboldHat1Obj.showToolTip()' onmouseout="ttClear()" onclick="koboldHat1Obj.buyGuildUpgrade()"></div>
                    <div id="koboldHat2" class="koboldHat2 shopItem shadowedItem shopHidden" onmouseover='koboldHat2Obj.showToolTip()' onmouseout="ttClear()" onclick="koboldHat2Obj.buyGuildUpgrade()"></div>
                    <div id="koboldHat3" class="koboldHat3 shopItem shadowedItem shopHidden" onmouseover='koboldHat3Obj.showToolTip()' onmouseout="ttClear()" onclick="koboldHat3Obj.buyGuildUpgrade()"></div>


                    <div id="etherealEdge" class="etherealEdge shopItem shadowedItem" onmouseover='etherealEdgeObj.showToolTip()' onmouseout="ttClear()" onclick="etherealEdgeObj.buyRateUpgradeItem()"></div>
                </div>
            </div>
        </div>
        <div id="guildSection" class="guildSection">
            <div class="guildHeader">Guild graphics go here</div>
            <div class="guildWrapper">
                <div class="theGuild">
                    <div class="newbTT" onmouseover="newbObj.showToolTip()" onmouseout="ttClear()">
                        <div id="newb" class="newb shadowed gBevel" onclick="newbObj.buy()" style="background: url(art/newbieBtn0.png)">
                            <div class="newbCount gCount">0</div>
                            <div class="newbCost gCost">10</div>
                        </div>
                    </div>
                    <div class="mercTT" onmouseover="mercObj.showToolTip()" onmouseout="ttClear()">
                        <div id="merc" class="merc shadowed bStyle gBevel guildHidden" onclick="mercObj.buy()" style="background: url(art/mercBtn0.png)">
                            <div class="mercCount gCount"></div>
                            <div class="mercCost gCost"></div>
                        </div>
                    </div>
                    <div class="koboldsTT" onmouseover="koboldObj.showToolTip()" onmouseout="ttClear()">
                        <div id="kobold" class="kobold shadowed bStyle gBevel guildHidden" onclick="koboldObj.buy()" style="background: url(art/koboldBtn0.png)">
                            <div class="koboldCount gCount"></div>
                            <div class="koboldCost gCost"></div>
                        </div>
                    </div>
                    <div class="roguesTT" onmouseover="rogueObj.showToolTip()" onmouseout="ttClear()">
                        <div id="rogue" class="rogue shadowed bStyle gBevel guildHidden" onclick="rogueObj.buy()" style="background: url(art/rogueBtn0.png)">
                            <div class="rogueCount gCount"></div>
                            <div class="rogueCost gCost"></div>
                        </div>
                    </div>
                    <div class="proHunterTT" onmouseover="proHunterObj.showToolTip()" onmouseout="ttClear()">
                        <div id="proHunter" class="proHunter shadowed bStyle gBevel guildHidden" onclick="proHunterObj.buy()" style="background: url(art/proHunterBtn0.png)">
                            <div class="proHunterCount gCount"></div>
                            <div class="proHunterCost gCost"></div>
                        </div>
                    </div>
                    <div class="jRPGProtagTT" onmouseover="jRPGProtagObj.showToolTip()" onmouseout="ttClear()">
                        <div id="jRPGProtag" class="jRPGProtag shadowed bStyle gBevel guildHidden" onclick="jRPGProtagObj.buy()" style="background: url(art/jRPGProtagBtn0.png)">
                            <div class="jRPGProtagCount gCount"></div>
                            <div class="jRPGProtagCost gCost"></div>
                        </div>
                    </div>


                </div>
            </div>
        </div>
    </div>
    <div id="updateSection" class="updateSection">
        <form action="https://trello.com/b/J6pqmDN8/clicker-game">
            <input type="submit" value="Trello Board" id="trelloBtn" class="trelloBtn" />
        </form><br>
        <form action="https://ko-fi.com/amortes">
            <input type="submit" value="Donate~" id="donationBtn" class="donationBtn" />
        </form><br>
        <p>Thanks for checking out my game! This is currently a work in progress, and I will be attempting to update daily until I feel like the game is in a playable and balanced state. <br><br> If you like my work, consider donating with the link at the
            top!
        </p>
        <ol><u><b>Update 2/26/2020</u></b>
            <li>Expanded on the guild upgrade framework to make way for multiple tiers of upgrades! What does this mean? MORE KOBOLD HATS!</li>
            <li>added more kobold hats.</li>
            <li>did an overhaul of the save and load functions. you won't see any difference, but its a lot easier for me to add new items and guild recruits.</li>
            <li>Added a patch version check to save files. This is a temporary solution that will be removed later. What this means is, if an old save file would break the game in a future update, it will simply not load the save file (this does mean you'll
                lose progress, but a better solution will be implemented before I consider this game out of prototype/alpha phase)</li>
        </ol>
        <ol><u><b>Update 2/25/2020</b></u>
            <li>Added the framework for guild upgrade items!</li>
            <li>added kobold hats. very important. Hat styles pending.</li>
            <li>updated the dragon art slightly</li>
        </ol>
        <ol><b><u>Update 2/24/2020</u></b>
            <li>slapped together a <a href="https://trello.com/b/J6pqmDN8/clicker-game">trello board</a> where you can check out a more in depth list of things that are planned and being worked on</li>
            <li>updated the dragon art! now slightly animated.</li>
        </ol>
        <ol><b><u>Update 2/23/2020</u></b>
            <li>Added offline progression, for real this time!</li>
            <li>updated the placeholder dragon. Not final art.</li>
            <li>new item art</li>
            <li>added a few items to the shop</li>
        </ol>
        <ol><b><u>Update 2/22/2020</u></b>
            <li>Created a solution to progression slowing while tabbed out, as well as offline progression (Limited to 1 hour, but future items/other features will raise this limit!)</li>
            <li>Slowed down progression, added some items to make clicks more meaningful, more to come soon!</li>
            <li>implemented a critical hit system</li>
        </ol>
        <ol><b><u>Update 2/21/2020</u></b>
            <li>added options button along with update pane and several options.</li>
            <li>Rogue art</li>
        </ol><br>
        <ol><b><u>Planned updates</u></b>
            <li>add missing art</li>
            <li>add an inventory pane where you can see all your purchased items</li>
            <li>implement a critical hit system, along with items that trigger various effects on crit</li>
            <li>give kobolds hats</li>
            <li>a stat panel, including things such as gold per click, damage, crit rate, and other various things</li>
            <li>add many more things to the shop and recruit sections</li>
            <li>balance the gameplay</li>
            <li>Future-proof some code for balance updates</li>
        </ol>
    </div>
    <button id="optionsBtn" class="optionsBtn"></button>
    <div id="options" class="options">
        <input type="checkbox" id="textJitter">Gold text jitter off<br>
        <input type="checkbox" id="updateToggle">Show update pane<br>
        <button id="deleteSaveBtn" class="deleteSaveBtn">Delete Save</button>
    </div>



    <script>
        //misc global variables
        var critMulti = 1;
        var critChance = 1;
        var afgLimit = 3.6e+6;
        var GAME_TICK = 1; //interval speed
        var gameInterval;
        var smallUpdateTime = 0;
        var bigUpdateTime = 0;
        var saveUpdateTime = 0;
        var currentInterval
        var delta
        var smallInterval
        var largeInterval
        var oldInterval
        var fpsInterval
        var fpsUpdate = 0
        var ttWindow = QS(".toolTipWindow")
        var gDisplay = QS(".goldDisplay")
        var playerName = QS(".playerName")
        var gold = 0
        var upgrades = 0
        var gpc = 1
        var gps = 0
        var flatClickUpgrades = 0
        var rateClickUpgrades = 0

        var dCanvas = document.getElementById("canvasDragon")
        var ctx = dCanvas.getContext("2d")
        ctx.font = "30px IMMORTAL"
        ctx.fillStyle = 'white';
        const theDragon = document.getElementById("theDragon")
        theDragon.addEventListener('click', dClicked)


        function QS(e) {
            return document.querySelector(e)
        }

        class guildRecruit {
            constructor(type, cost, count, costEle, countEle, costMult, multFloor, gpsI, title, desc1, desc2, desc3) {
                this.type = type
                this.cost = cost
                this.count = count
                this.costEle = costEle
                this.countEle = countEle
                this.costMult = costMult
                this.multFloor = multFloor
                this.gpsI = gpsI
                this.title = title
                this.desc1 = desc1
                this.desc2 = desc2
                this.desc3 = desc3
            }

            priceCheckGuild() {
                if (this.cost <= gold) {
                    this.type.classList.remove("shadowed")
                } else {
                    this.type.classList.add("shadowed")
                }
            }

            buy() {
                if (gold >= this.cost) {
                    gold = gold - this.cost
                    this.count = this.count + 1
                    this.cost = this.cost + Number((this.cost * this.costMult).toFixed(0))
                    this.costMult = this.costMult - 0.05
                    if (this.costMult < this.multFloor) {
                        this.costMult = this.multFloor
                    }
                    QS(this.countEle).innerText = this.count
                    QS(this.costEle).innerText = this.cost
                    gps = gps + this.gpsI
                    gDisplay.innerHTML = `Gold: ${gold.toFixed(0)}`
                    gpsDisplay.innerHTML = `Gold per second : ${gps.toFixed(2)}`
                }

            }
            update() {
                QS(this.countEle).innerText = this.count
                QS(this.costEle).innerText = this.cost
                this.type.classList.remove("guildHidden")
            }
            reveal() {
                if (gold * 2 >= this.cost) {
                    this.type.classList.remove("guildHidden")
                    QS(this.countEle).innerText = this.count
                    QS(this.costEle).innerText = this.cost
                }
            }
            showToolTip() {
                ttWindow.style.display = "block"
                ttWindow.childNodes[1].innerText = ""
                ttWindow.childNodes[2].src = ""
                ttWindow.childNodes[4].innerText = this.title
                ttWindow.childNodes[7].innerText = this.desc1 + String(this.desc2) + this.desc3
            }
        }

        class shopItem {
            constructor(type, cost, title, desc, crit, mult, guildObj, revealAt, upgradeTier) {
                this.type = type
                this.cost = cost
                this.title = title
                this.desc = desc
                this.crit = crit
                this.mult = mult
                this.guildObj = guildObj
                this.revealAt = revealAt
                this.upgradeTier = upgradeTier
            }
            priceCheckItem() {
                if (this.cost <= gold) {
                    this.type.classList.remove("shadowedItem")
                } else {
                    this.type.classList.add("shadowedItem")
                }
            }
            buyFlatUpgradeItem() {
                if (this.cost <= gold) {
                    gold = gold - this.cost
                    flatClickUpgrades++
                    critChance = critChance + this.crit
                    critMulti = critMulti + this.mult
                    this.type.classList.add("shopDisable")
                }
            }
            buyRateUpgradeItem() {
                if (this.cost <= gold) {
                    gold = gold - this.cost
                    rateClickUpgrades = rateClickUpgrades + 0.01
                    critChance = critChance + this.crit
                    critMulti = critMulti + this.mult
                    this.type.classList.add("shopDisable")
                }
            }
            revealItem() {
                if (gold * 2 >= this.cost) {
                    this.type.classList.remove("shopHidden")
                }
            }
            revealUpgrade() {
                if (this.guildObj.count >= this.revealAt) {
                    this.type.classList.remove("shopHidden")
                }
            }
            showToolTip() {
                ttWindow.style.display = "block"
                ttWindow.childNodes[1].innerText = this.cost
                ttWindow.childNodes[2].src = "art/coinStack.png"
                ttWindow.childNodes[4].innerText = this.title
                ttWindow.childNodes[7].innerText = this.desc
            }
            buyGuildUpgrade() {
                if (this.cost <= gold) {
                    gold = gold - this.cost
                    gpsDisplay.innerHTML = `Gold per second : ${gps.toFixed(2)}`
                    gps = gps + (this.guildObj.count * this.guildObj.gpsI)
                    this.guildObj.gpsI = this.guildObj.gpsI * 2
                    this.guildObj.desc2 = this.guildObj.desc2 * 2
                    if (typeof this.upgradeTier !== "undefined") {
                        let str = this.guildObj.type.style.backgroundImage
                        str = str.slice(0, -7)
                        this.guildObj.type.style.backgroundImage = `${str}` + `${this.upgradeTier}` + `.png")`
                    }
                    this.type.classList.add("shopDisable")
                }
            }
        }

        //Clicking the dragon
        function dClicked(e) {
            posX = e.clientX
            posY = e.clientY
            let rgn = rngInt(1, 100 / critChance)
            if (rgn == 1) {
                finalGpc = (gpc + flatClickUpgrades + (gps * rateClickUpgrades)) * critMulti
                gold = gold + finalGpc
                gDisplay.innerHTML = `Gold: ${gold.toFixed(0)}`
                var goldAnim = $('<div  class="animation anim" style="top:' + (posY - 10) + 'px; left:' + (posX + rngInt(-25, -5)) + 'px">+' + finalGpc.toFixed(2) + '</div>');
                var damageAnim = $('<div  class="critDmgAnim anim" style="top:' + (posY + rngInt(0, 20)) + 'px; left:' + (posX + rngInt(0, 40)) + 'px"></div>');
            } else {
                finalGpc = gpc + flatClickUpgrades + (gps * rateClickUpgrades)
                gold = gold + finalGpc
                gDisplay.innerHTML = `Gold: ${gold.toFixed(0)}`
                var goldAnim = $('<div  class="animation anim" style="top:' + (posY - 10) + 'px; left:' + (posX + rngInt(-25, -5)) + 'px">+' + finalGpc.toFixed(2) + '</div>');
                var damageAnim = $('<div  class="dmgAnim anim" style="top:' + (posY + rngInt(0, 20)) + 'px; left:' + (posX + rngInt(0, 40)) + 'px"></div>');
            }
            $('#animations').append(goldAnim);
            $('#animations').append(damageAnim);
            $('#animations').on("animationend webkitAnimationEnd oAnimationEnd MSAnimationEnd", '.anim',
                function() {
                    $(this).off();
                    $(this).remove();
                });

        }

        //Guild Objs-----------
        //elementID, cost, count, costElementClass, CountElementClass, costMultiplier, multiplierFloor, gpsIncrease, tooltip title, tooltip description 1 2 3

        const newbObj = new guildRecruit(newb, 10, 0, ".newbCost", ".newbCount", 0.25, 0.04, 0.1, "Newbie", "Ready for their first adventure,\ncomplete with red shirt!\n\n+", 0.1, " gold per second")
        const mercObj = new guildRecruit(merc, 100, 0, ".mercCost", ".mercCount", 0.15, 0.07, 1, "Mercenary", "A slightly more experienced adventurer.\nOnly slighty.\n\n+", 1, " gold per second")
        const koboldObj = new guildRecruit(kobold, 500, 0, ".koboldCost", ".koboldCount", 0.25, 0.05, 5, "Kobold", "I'm not sure how they got past guild\nregistration, but they're really good at\nhoarding gold!\n\n+", 5, " gold per second")
        const rogueObj = new guildRecruit(rogue, 5000, 0, ".rogueCost", ".rogueCount", 0.3, 0.1, 20, "Rogue", "Stealing gold is literally their job.\n\n+", 20, " gold per second")
        const proHunterObj = new guildRecruit(proHunter, 30000, 0, ".proHunterCost", ".proHunterCount", 0.35, 0.2, 100, "Professional Hunter", "The best gear.\nThe best stats.\nThe best DPS.\nbut at what cost?\n\n+", 100, " gold per second\n+1 second-hand embarassment.")
        const jRPGProtagObj = new guildRecruit(jRPGProtag, 99999, 0, ".jRPGProtagCost", ".jRPGProtagCount", 0.45, 0.25, 999, "jRPG Protagonist", "\n彼は殺されるなどの小さなことで死ぬことはありません。\n\n+", 999, " gold per second", 1)


        //Item Objs-------------
        //type, cost, tooltip title, tooltip description, critical chance increase, additional crit multiplier, elementid, guildObjName
        //Flat Upgrade Items
        const ironSwordObj = new shopItem(ironSword, 300, "Iron Sword", "A basic iron sword. Cheap and effective.\n\n+1 Gold per click", 0, 0)
        const steelSwordObj = new shopItem(steelSword, 3000, "Steel Sword", "A slight improvment.\n\n+1 Gold per click\n+25% more gold on crit", 0, 0.25)
        const boneSwordObj = new shopItem(boneSword, 30000, "Bone Sword", "The shop keeper swears it's stronger than steel...\nNumbers don't lie, I guess.\n\n+1 Gold per click\n+1% crit rate\n+25% more gold on crit", 1, 0.25)
        const greatSwordObj = new shopItem(greatSword, 300000, "Great Sword", "It's great.\n\n+1 Gold per click\n+3% crit rate\n+50% more gold on crit", 3, 0.5)

        //Rate Upgrade Items
        const goldenLoopObj = new shopItem(goldenLoop, 10000, "Golden Loop", "Round it goes, gold through and through\nnever ending...\n\n+1% of your GPS per click", 0, 0)
        const ringOfMidasObj = new shopItem(ringOfMidas, 100000, "Ring of Midas", "Every swing of your sword creates gold!\nWhat even is inflation?!\n\n+1% of your GPS per click", 0, 0)

        //Crit upgrades

        //the final item
        const etherealEdgeObj = new shopItem(etherealEdge, 9999999999, "Ethereal Edge", "On display as the shops most prestigious weapon.\nThe blade looks as if it could cut through anything.\n\n+1 True damage (Not yet implemented.)\n+10% crit rate\n+300% more gold on crit", 10, 3)

        //guild upgrades
        const newbManual1Obj = new shopItem(newbManual1, 10, "Introduction to adventuring", "A helpful guide for newbies. Printed in mass.\n\nNewbies are twice as efficient", 0, 0, newbObj, 10)
        const newbManual2Obj = new shopItem(newbManual2, 50, "Swordfighting for dummies", "Another guide for your newbie recruits.\n\nNewbies are twice as efficient", 0, 0, newbObj, 20)

        const koboldHat1Obj = new shopItem(koboldHat1, 10000, "Fancy hat", "Increases Kobold productivity two fold!\n\nKobolds are twice as efficient", 0, 0, koboldObj, 10, 01)
        const koboldHat2Obj = new shopItem(koboldHat2, 20000, "Miniature crown", "Make every kobold feel like royalty.\nHopefully it doesn't go to their heads.\n\nKobolds are twice as efficient", 0, 0, koboldObj, 20, 02)
        const koboldHat3Obj = new shopItem(koboldHat3, 30000, "Legendary Hero's cap", "Kobolds feel more heroic and inspired\nto adventure with this hat.\n\nKobolds are twice as efficient", 0, 0, koboldObj, 30, 03)

        //Object arrays for updates and save/load
        const guildObjs = [newbObj, mercObj, koboldObj, rogueObj, proHunterObj, jRPGProtagObj]
        const playerItemObjs = [ironSwordObj, steelSwordObj, boneSwordObj, greatSwordObj, goldenLoopObj, ringOfMidasObj, etherealEdgeObj]
        const guildItemObjs = [newbManual1Obj, newbManual2Obj, koboldHat1Obj, koboldHat2Obj, koboldHat3Obj]

        const patchVersion = 0.01


        //Misc Functions------------------------------------------
        function changeName() {
            playerName.innerText = prompt("What is your name?")
        }

        function clear() {
            ctx.clearRect(0, 0, dCanvas.width, dCanvas.height)
        }

        function ttClear() {
            ttWindow.style.display = "none"
        }

        function rngInt(min, max) {
            min = Math.ceil(min);
            max = Math.floor(max);
            return Math.floor(Math.random() * (max - min + 1)) + min; //The maximum is inclusive and the minimum is inclusive 
        }
        //--------------------------------------------------------


        //Game tick functions-------------------------------------
        function onGameTick() { //The core game interval
            currentInterval = Date.now();
            delta = currentInterval - oldInterval; // currently unused, but can be used in the future to handle things
            oldInterval = currentInterval; // that happen while the game is closed

            smallInterval = currentInterval - smallUpdateTime; //this starts as 0
            largeInterval = currentInterval - bigUpdateTime; //this too
            fpsInterval = currentInterval - fpsUpdate;
            saveInterval = currentInterval - saveUpdateTime;
            if (fpsInterval >= 1000 / 30) {
                fpsUpdate = currentInterval;
                clear();
            }
            if (delta >= 110) {
                updateGoldAFK(delta);
            } else if (smallInterval >= 98) {
                smallUpdateTime = currentInterval;
                updateGold();
            }

            if (largeInterval >= 250) {
                bigUpdateTime = currentInterval;
                updateOtherStuff();

            }
            if (saveInterval >= 5000) {
                saveUpdateTime = currentInterval;
                saveGame();
            }
        };

        function updateGold() {
            gold = gold + (gps / 10)
            gDisplay.innerHTML = `Gold: ${gold.toFixed(0)}`
            gpsDisplay.innerHTML = `Gold per second : ${gps.toFixed(2)}`
        }

        function updateGoldAFK(delta) { // delta 500 example... gold + (gps/1000)*delta
            if (delta <= afgLimit) {
                gold = gold + (gps / 1000) * delta
                gDisplay.innerHTML = `Gold: ${gold.toFixed(0)}`
                gpsDisplay.innerHTML = `Gold per second : ${gps.toFixed(2)}`
            } else {
                gold = gold + (gps / 1000) * afgLimit
                gDisplay.innerHTML = `Gold: ${gold.toFixed(0)}`
                gpsDisplay.innerHTML = `Gold per second : ${gps.toFixed(2)}`
            }
        }

        function updateOtherStuff() {
            guildObjs.forEach(i => {
                i.priceCheckGuild()
                i.reveal()
            });

            playerItemObjs.forEach(i => {
                i.priceCheckItem()
                i.revealItem()
            });
            guildItemObjs.forEach(i => {
                i.priceCheckItem()
                i.revealUpgrade()
            })
        }
        //--------------------------------------------------------

        //Save and Load game functions ---------------------------
        function saveGame() {
            var save = {
                patchVersion: patchVersion,

                //------------misc saved variables
                textJitter: document.getElementById("textJitter").checked,
                oldInterval: oldInterval,
                gold: gold,
                gps: gps,
                flatClickUpgrades: flatClickUpgrades,
                rateClickUpgrades: rateClickUpgrades,
                critChance: critChance,
                critMulti: critMulti,

                //------------recruits
                guildSaves: guildObjs,
                guildClassLists: guildObjs.map(x => x.type.classList.value),
                guildBGs: guildObjs.map(x => x.type.style.backgroundImage),

                //------------items
                playerItems: playerItemObjs.map(x => x.type.classList.value),
                upgradeItems: guildItemObjs.map(x => x.type.classList.value),
            }
            localStorage.setItem("save", JSON.stringify(save));
            //console.log('saved')
        }

        function loadGame() {
            var savegame = JSON.parse(localStorage.getItem("save"));

            if (savegame !== null) {
                if (savegame.patchVersion != patchVersion) {
                    return;
                }
                oldInterval = savegame.oldInterval;
                if (typeof savegame.gold !== "undefined") gold = savegame.gold;
                if (typeof savegame.gps !== "undefined") gps = savegame.gps;
                if (typeof savegame.flatClickUpgrades !== "undefined") flatClickUpgrades = savegame.flatClickUpgrades;
                if (typeof savegame.rateClickUpgrades !== "undefined") rateClickUpgrades = savegame.rateClickUpgrades;
                if (typeof savegame.critChance !== "undefined") critChance = savegame.critChance;
                if (typeof savegame.critMulti !== "undefined") critMulti = savegame.critMulti;
                if (typeof savegame.playerName !== "undefined") playerName.innerText = savegame.playerName;
                document.getElementById("textJitter").checked = savegame.textJitter;
                savegame.guildSaves.forEach((e, i) => rLoadTest(e, i, guildObjs))
                savegame.guildClassLists.forEach((e, i) => cLoadTest(e, i, guildObjs))
                savegame.guildBGs.forEach((e, i) => imgLoadTest(e, i, guildObjs))
                savegame.playerItems.forEach((e, i) => piLoadTest(e, i, playerItemObjs))
                savegame.upgradeItems.forEach((e, i) => piLoadTest(e, i, guildItemObjs))
            }

        }

        function rLoadTest(e, i, obj) {
            if (typeof e.cost !== "undefined") {
                obj[i].cost = e.cost
            }
            if (typeof e.count !== "undefined") {
                obj[i].count = e.count
            }
            if (typeof e.gpsI !== "undefined") {
                obj[i].gpsI = e.gpsI
            }
            if (typeof e.desc2 !== "undefined") {
                obj[i].desc2 = e.desc2
            }
        }

        function cLoadTest(e, i, obj) {
            if (e.search("guildHidden") == -1) {
                obj[i].update()
            }
        }

        function imgLoadTest(e, i, obj) {
            if (typeof e !== "undefined") {
                obj[i].type.style.backgroundImage = e
            }
        }

        function piLoadTest(e, i, obj) {
            if (typeof e !== "undefined") {
                obj[i].type.classList = e
            }
        }

        function deleteSave() {
            localStorage.removeItem("save")
            window.location.reload(false);
        }

        //--------------------------------------------------------

        function onStartup() {
            if (gameInterval) { //if an interval is set for some reason, clear it
                clearInterval(gameInterval);
                gameInterval = null;
            }
            gameInterval = setInterval(onGameTick, GAME_TICK); // do the things in onGameTick at the rate of GAME_TICK

        }

        function onShutdown() {
            if (gameInterval) {
                clearInterval(gameInterval);
                gameInterval = null;
            }
        }

        //Stuff that happens on page load
        loadGame();
        onStartup();
        $("#options").hide()

        if (document.getElementById("textJitter").checked) {
            $(".goldDisplay").css({
                "position": "absolute",
                "left": "246px"
            })
            $(".gpsDisplay").css({
                "position": "absolute",
                "left": "228px",
                "bottom": "3px"
            })
        }
        document.getElementById("updateToggle").checked = true;
        //$("#updateSection").hide()

        $("#optionsBtn").click(function() {
            $("#options").toggle();
        })

        $("#deleteSaveBtn").click(deleteSave)
        $("#textJitter").change(
            function() {
                if (this.checked) {
                    $(".goldDisplay").css({
                        "position": "absolute",
                        "left": "246px"
                    })
                    $(".gpsDisplay").css({
                        "position": "absolute",
                        "left": "228px",
                        "bottom": "3px"
                    })
                } else {
                    $(".goldDisplay").css({
                        "position": "static"
                    })
                    $(".gpsDisplay").css({
                        "position": "static"
                    })
                }

            });
        $("#updateToggle").change(
            function() {
                $("#updateSection").toggle()
            }
        )

        //AFG Handlers
        window.addEventListener("focus", function(event) {
            onStartup();
        }, false);
        window.addEventListener("blur", function(event) {
            onShutdown();
        }, false);
    </script>
</body>

</html>